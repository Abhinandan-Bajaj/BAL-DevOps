SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[USP_ASM_CV_SERVICE_SERVICE_FULLLOAD] AS 
BEGIN
/*******************************************HISTORY**************************************************/
/*--------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------*/
/*    DATE   	|	CREATED/MODIFIED BY		|CHANGE DESCRIPTION			    */
/*--------------------------------------------------------------------------------------------------*/
/*	2024-08-30 	|	Ashwini Ahire		| Phase 3 Code added                        */
/*	2024-08-29 	|	Sarvesh Kulkarni	| Handled deleted JC and commented Open JC table which is shifted to new table */
/*	2024-08-11 	|	Sarvesh Kulkarni	| Handled Cancelled JC issue and removed conditions on closed and qtyallocated columns to remove the revenue missmatch */
/*	2025-02-13 	|	Dewang Makani	    | P3 EOH screen logic addition */
/*--------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------*/
/*******************************************HISTORY**************************************************/

TRUNCATE TABLE ASM_CV_SERVICE_STG
--TRUNCATE TABLE ASM_CV_OPEN_JC_REPORT

INSERT INTO ASM_CV_SERVICE_STG
(Type
,FK_Contracttypeid
,Lineid
,FK_Docid
,DOCNAME
,Docdate
,FK_Companyid
,FK_Contactid
,Isclosed
,FK_Itemid
,Qty
,Qtyallocated
,Qtycancelled
,Qtyreturned
,Rate
,Totaltax
,Tradediscount
,FK_Ibid
,Usagereading
,Totalamount
,FK_Branchid
,FK_Modelid
,BU
,COMPANYTYPE
,Isrevisited
,Isrepeated
,[2HrsTat_Delivery]
,[7DaysTat_Delivery]
,Jcvaluebracket
,TAT_Days
,Pdt_Flag
,Pdc_Flag
,Pretaxrevenue
,Itemgrouptype
,PaidFlag
,ServiceType
,DealerCode
,Importeddate
,InvoiceDate
,Vehicleinvoicedatetime
,Billeddatetime
,Delete_Flag
,Service_Retail_TypeIdentifier
,PartRepairType
,DefectCode
,DefectDescription
,DefectCode_Description
,PDIOk_Flag
,PDINotOk_Flag
,PDINowOk_Flag
,Qtyinvoiced
,JobCardStatus
,FK_PartContracttypeid
,Posttaxrevenue
,[3rdFS_To_1stPS]
,[1st_Ps_Date]
,[3rd_Fs_Date]
,CANCELLATIONDATE
,EOH_Flag
,EOH_Flag_Pre
)

SELECT BASE.*
,Pretaxrevenue+Totaltax AS Posttaxrevenue
,CAST(NULL AS INT) [3rdFS_To_1stPS]
,CAST(NULL AS DATE) [1st_Ps_Date]
,CAST(NULL AS DATE) [3rd_Fs_Date]
,null as CANCELLATIONDATE
,null as EOH_Flag
,null as EOH_Flag_Pre
FROM
(SELECT DISTINCT 
  SL.Type
 ,SH.CONTRACTTYPEID AS [FK_Contracttypeid]
 ,SL.LINEID AS Lineid
 ,SH.HEADERID AS [FK_Docid]
 ,SH.DOCNAME
 ,CAST(SH.Docdate AS DATE) AS Docdate
 ,SH.COMPANYID AS [FK_Companyid]
 ,SH.CONTACTID AS FK_Contactid
 ,SH.Isclosed
 ,SL.ITEMID AS [FK_Itemid]
 ,SL.Qty
 ,SL.Qtyallocated
 ,SL.Qtycancelled
 ,SL.Qtyreturned
 ,SL.Rate
 ,SL.Totaltax
 ,SL.Tradediscount
 ,SH.IBID AS [FK_Ibid]
 ,SH.Usagereading
 ,SH.Totalamount
 ,SH.BRANCHID AS [FK_Branchid]
 ,SH.MODELID AS [FK_Modelid]
 ,SH.BU
 ,CM.COMPANYTYPE
 ,SH.Isrevisited 
 ,SL.Isrepeated
,CASE WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=0 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<15 THEN '0-15Mins'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=15 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<30 THEN '15-30Mins'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=30 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<120 THEN '30Mins-2hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=120 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<180 THEN '2-3hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=180 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<300 THEN '3-5hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=300 THEN '>5hrs' END AS [2HrsTat_Delivery]
,CASE WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=0 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<2 THEN '0-2hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=2 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<4 THEN '2-4hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=4 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<8 THEN '4-8hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=8 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<24 THEN '8-24hrs'
      WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=1 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<2 THEN '1-2days'
      WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=2 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<3 THEN '2-3days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=3 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<5 THEN '3-5days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=5 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<7 THEN '5-7days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=7 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<10 THEN '7-10days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=10 THEN '>10days'
	  END AS [7DaysTat_Delivery]   
,CASE WHEN SH.TOTALAMOUNT>=0 AND SH.TOTALAMOUNT<20 THEN '<20'
      WHEN SH.TOTALAMOUNT>=20 AND SH.TOTALAMOUNT<50 THEN '20-50'
      WHEN SH.TOTALAMOUNT>=50 AND SH.TOTALAMOUNT<100 THEN '50-100'
      WHEN SH.TOTALAMOUNT>=100 AND SH.TOTALAMOUNT<250 THEN '100-250'
      WHEN SH.TOTALAMOUNT>=250 AND SH.TOTALAMOUNT<500 THEN '250-500'
      WHEN SH.TOTALAMOUNT>=500 THEN '>500' END AS Jcvaluebracket 
,DATEDIFF(DAY,SH.DOCDATE,SH.Billeddatetime) AS TAT_Days
 ,CASE WHEN SH.READYFORBILLDATETIME<=SH.ESTTIMEGIVENTOCUSTOMER THEN 1 ELSE 0 END AS Pdt_Flag
 ,CASE WHEN SH.CUSTOMERPAIDAMOUNT < = SH.TOTALOFESTIMATEDCOST THEN 1 ELSE 0 END AS Pdc_Flag
 ,CASE WHEN SL.QtyAllocated = 0 Then (((SL.Qty - SL.QtyCancelled) * SL.Rate)   - SL.TradeDiscount ) 
       Else (((SL.QtyAllocated - SL.QtyReturned) * SL.Rate ) - SL.TradeDiscount ) END AS Pretaxrevenue
 ,CAST(IG.Itemgrouptype AS NVARCHAR(225)) AS Itemgrouptype
 ,CASE WHEN SH.CONTRACTTYPEID NOT IN (173,186,185,174,191,214,184,48,175,210,211,176,215,213,190,212,8) THEN 1
	   WHEN SH.CONTRACTTYPEID=8 AND DOCNAME LIKE '%PDI%' THEN 0
       ELSE 0 END AS 'PaidFlag'            
 ,SCM1.NAME AS ServiceType
 ,CM.CODE AS DealerCode
 ,SH.Importeddate
 ,IBM.INVOICEDATE AS InvoiceDate
 ,CAST(SH.Vehicleinvoicedatetime AS DATE) AS Vehicleinvoicedatetime
 ,CAST(SH.Billeddatetime AS DATE) AS Billeddatetime
 ,0 AS Delete_Flag
 ,101 AS Service_Retail_TypeIdentifier
,CASE 	 
	WHEN 
		SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts') 
		AND (im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365')
		OR SLE.DefectCode NOT IN ('3W-001','555','556'))
		AND SL.CONTRACTTYPEID in ('2','5','6','7','9','10','13','14','23','37','41','42','43','44','45','49','50',
		'51','52','53','54','55','56','57','58','59','60','61','62','166','171','177','184','186','199',
		'209','210','211','212','213') 
	THEN 'Paid'
	WHEN 
		SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts')
		AND im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365') 
		AND SLE.DefectCode NOT IN ('3W-001','555','556','049')
		AND SL.CONTRACTTYPEID in ('3','4','8','38','39','40','48','63','168','172','174','175','176','190','191') 
	THEN 'Warranty'
	WHEN SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts')
		AND im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365') 
		AND SLE.DefectCode IN ('049')
		AND SL.CONTRACTTYPEID in ('3','4','8','38','39','40','48','63','168','172','174','175','176','190','191') 
	THEN 'CD_Parts'
	WHEN im.code IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
			     '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176','36BB0054','24151071','36BB0053','36AZ0078','AL151179',
			     '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
			     'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
			     '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
			     'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
			     'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
			     '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
			     '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
			     '36001051','BF172365') 
	THEN 'PM_Parts'
	ELSE 'Others'
END AS PartRepairType 
,SLE.DefectCode AS DefectCode
,CME.Name AS DefectDescription 
,concat(CME.Name, ' - ' , SLE.DefectCode) as DefectCode_Description -- added on 07/02/2024
,SH.PDIOk AS PDIOk_Flag
,SH.PDINotOk AS PDINotOk_Flag
,SH.PDINowOk AS PDINowOk_Flag
,SL.Qtyinvoiced
,CASE 
    WHEN SH.ISCLOSED = 0 AND (SH.READYFORBILLDATETIME IS NULL OR SH.READYFORBILLDATETIME IS NOT NULL) AND SH.BILLEDDATETIME IS NULL 
	THEN 'Open'
	WHEN SH.ISCLOSED = 1 AND SH.READYFORBILLDATETIME IS NOT NULL AND SH.BILLEDDATETIME IS NOT NULL 
	THEN 'Delivered/Closed'
END AS JobCardStatus
,SL.CONTRACTTYPEID AS FK_PartContractTypeID

FROM SERVICE_HEADER SH
LEFT JOIN SERVICE_LINE SL ON (SL.DOCID = SH.HEADERID AND SL.IMPORTEDDATE = (SELECT MAX(SL1.IMPORTEDDATE) FROM SERVICE_LINE SL1 WHERE SL1.ITEMID = SL.ITEMID AND SL.DOCID = SL1.DOCID))
INNER JOIN BAL_Cequity_JCData_Updated BCD ON BCD.LINEID=SL.LINEID
INNER JOIN SERVICE_CONTRACT_MASTER SCM1 ON SCM1.SERVICECONTRACTID=SH.CONTRACTTYPEID
LEFT JOIN INSTALL_BASE_MASTER IBM ON IBM.IBID=SH.IBID
LEFT JOIN ITEM_GROUP_DETAIL_NEW IG ON IG.ITEMID=SL.ITEMID AND IG.ID = (SELECT MAX(IG1.ID) FROM ITEM_GROUP_DETAIL_NEW IG1 WHERE IG.ITEMID = IG1.ITEMID)
LEFT JOIN ITEM_MASTER IM ON IM.ITEMID=SL.ITEMID 
INNER JOIN COMPANY_MASTER CM ON (CM.COMPANYID=SH.COMPANYID AND CM.IMPORTEDDATE = (SELECT MAX(CM1.IMPORTEDDATE) FROM COMPANY_MASTER CM1 WHERE CM.COMPANYID = CM1.COMPANYID)
AND CM.COMPANYTYPE IN (7))
LEFT JOIN SERVICE_LINE_EXT SLE ON SLE.LINEID = SL.LINEID  -- New join added for phase 3 for defect code and defect description
LEFT JOIN COMPLAINT_MASTER CME ON CME.Code = SLE.DefectCode --->  -- New join added for phase 3 for defect code and defect description with the defect master table CHANGE TO LEFT JOIN
WHERE CAST(SH.DOCDATE AS DATE) BETWEEN '2022-04-01' AND '2023-11-07'
AND SH.IBID IS NOT NULL
AND SH.CANCELLATIONDATE IS NULL
--AND SL.ISCLOSED<>0
--AND SL.QTYALLOCATED<>0
)BASE

--For JC after 7th Nov
INSERT INTO ASM_CV_SERVICE_STG
(Type
,FK_Contracttypeid
,Lineid
,FK_Docid
,DOCNAME
,Docdate
,FK_Companyid
,FK_Contactid
,Isclosed
,FK_Itemid
,Qty
,Qtyallocated
,Qtycancelled
,Qtyreturned
,Rate
,Totaltax
,Tradediscount
,FK_Ibid
,Usagereading
,Totalamount
,FK_Branchid
,FK_Modelid
,BU
,COMPANYTYPE
,Isrevisited
,Isrepeated
,[2HrsTat_Delivery]
,[7DaysTat_Delivery]
,Jcvaluebracket
,TAT_Days
,Pdt_Flag
,Pdc_Flag
,Pretaxrevenue
,Itemgrouptype
,PaidFlag
,ServiceType
,DealerCode
,Importeddate
,InvoiceDate
,Vehicleinvoicedatetime
,Billeddatetime
,Delete_Flag
,Service_Retail_TypeIdentifier
,PartRepairType
,DefectCode
,DefectDescription
,DefectCode_Description
,PDIOk_Flag
,PDINotOk_Flag
,PDINowOk_Flag
,Qtyinvoiced
,JobCardStatus
,FK_PartContracttypeid
,Posttaxrevenue
,[3rdFS_To_1stPS]
,[1st_Ps_Date]
,[3rd_Fs_Date]
,CANCELLATIONDATE
,EOH_Flag
,EOH_Flag_Pre
)


SELECT BASE.*
,Pretaxrevenue+Totaltax AS Posttaxrevenue
,CAST(NULL AS INT) [3rdFS_To_1stPS]
,CAST(NULL AS DATE) [1st_Ps_Date]
,CAST(NULL AS DATE) [3rd_Fs_Date]
,null as CANCELLATIONDATE
,null as EOH_Flag
,null as EOH_Flag_Pre
FROM
(SELECT DISTINCT 
  SL.Type
 ,SH.CONTRACTTYPEID AS [FK_Contracttypeid]
 ,SL.LINEID AS Lineid
 ,SH.HEADERID AS [FK_Docid]
 ,SH.DOCNAME
 ,CAST(SH.Docdate AS DATE) AS Docdate
 ,SH.COMPANYID AS [FK_Companyid]
 ,SH.CONTACTID AS FK_Contactid
 ,SH.Isclosed
 ,SL.ITEMID AS [FK_Itemid]
 ,SL.Qty
 ,SL.Qtyallocated
 ,SL.Qtycancelled
 ,SL.Qtyreturned
 ,SL.Rate
 ,SL.Totaltax
 ,SL.Tradediscount
 ,SH.IBID AS [FK_Ibid]
 ,SH.Usagereading
 ,SH.Totalamount
 ,SH.BRANCHID AS [FK_Branchid]
 ,SH.MODELID AS [FK_Modelid]
 ,SH.BU
 ,CM.COMPANYTYPE
 ,SH.Isrevisited 
 ,SL.Isrepeated 
,CASE WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=0 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<15 THEN '0-15Mins'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=15 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<30 THEN '15-30Mins'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=30 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<120 THEN '30Mins-2hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=120 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<180 THEN '2-3hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=180 AND DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<300 THEN '3-5hrs'
      WHEN DATEDIFF(MI,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=300 THEN '>5hrs' END AS [2HrsTat_Delivery]
,CASE WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=0 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<2 THEN '0-2hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=2 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<4 THEN '2-4hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=4 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<8 THEN '4-8hrs'
      WHEN DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=8 AND DATEDIFF(HH,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<24 THEN '8-24hrs'
      WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=1 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<2 THEN '1-2days'
      WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=2 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<3 THEN '2-3days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=3 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<5 THEN '3-5days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=5 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<7 THEN '5-7days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=7 AND DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)<10 THEN '7-10days'
	  WHEN DATEDIFF(DAY,SH.JOBCARDCREATEDDATETIME,SH.READYFORBILLDATETIME)>=10 THEN '>10days'
	  END AS [7DaysTat_Delivery]   
,CASE WHEN SH.TOTALAMOUNT>=0 AND SH.TOTALAMOUNT<20 THEN '<20'
      WHEN SH.TOTALAMOUNT>=20 AND SH.TOTALAMOUNT<50 THEN '20-50'
      WHEN SH.TOTALAMOUNT>=50 AND SH.TOTALAMOUNT<100 THEN '50-100'
      WHEN SH.TOTALAMOUNT>=100 AND SH.TOTALAMOUNT<250 THEN '100-250'
      WHEN SH.TOTALAMOUNT>=250 AND SH.TOTALAMOUNT<500 THEN '250-500'
      WHEN SH.TOTALAMOUNT>=500 THEN '>500' END AS Jcvaluebracket 
,DATEDIFF(DAY,SH.DOCDATE,SH.Billeddatetime) AS TAT_Days
 ,CASE WHEN SH.READYFORBILLDATETIME<=SH.ESTTIMEGIVENTOCUSTOMER THEN 1 ELSE 0 END AS Pdt_Flag
 ,CASE WHEN SH.CUSTOMERPAIDAMOUNT < = SH.TOTALOFESTIMATEDCOST THEN 1 ELSE 0 END AS Pdc_Flag
 ,CASE WHEN SL.QtyAllocated = 0 Then (((SL.Qty - SL.QtyCancelled) * SL.Rate)   - SL.TradeDiscount ) 
       Else (((SL.QtyAllocated - SL.QtyReturned) * SL.Rate ) - SL.TradeDiscount ) END AS Pretaxrevenue
 ,CAST(IG.Itemgrouptype AS NVARCHAR(225)) AS Itemgrouptype
 ,CASE WHEN SH.CONTRACTTYPEID NOT IN (173,186,185,174,191,214,184,48,175,210,211,176,215,213,190,212,8) THEN 1
	   WHEN SH.CONTRACTTYPEID=8 AND DOCNAME LIKE '%PDI%' THEN 0
       ELSE 0 END AS 'PaidFlag'             
 ,SCM1.NAME AS ServiceType
 ,CM.CODE AS DealerCode
 ,SH.Importeddate
 ,IBM.INVOICEDATE AS InvoiceDate
 ,CAST(SH.Vehicleinvoicedatetime AS DATE) AS Vehicleinvoicedatetime
 ,CAST(SH.Billeddatetime AS DATE) AS Billeddatetime
 ,0 AS Delete_Flag
 ,101 AS Service_Retail_TypeIdentifier
,CASE 	 
	WHEN 
		SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts') 
		AND (im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365')
		OR SLE.DefectCode NOT IN ('3W-001','555','556'))
		AND SL.CONTRACTTYPEID in ('2','5','6','7','9','10','13','14','23','37','41','42','43','44','45','49','50',
		'51','52','53','54','55','56','57','58','59','60','61','62','166','171','177','184','186','199',
		'209','210','211','212','213') 
	THEN 'Paid'
	WHEN 
		SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts')
		AND im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365') 
		AND SLE.DefectCode NOT IN ('3W-001','555','556','049')
		AND SL.CONTRACTTYPEID in ('3','4','8','38','39','40','48','63','168','172','174','175','176','190','191') 
	THEN 'Warranty'
	WHEN SL.TYPE = 'Part' AND IG.ITEMGROUPTYPE IN ('BAL Parts')
		AND im.code NOT IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
		  '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176', '36BB0054','24151071','36BB0053','36AZ0078','AL151179',
		  '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
		  'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
		  '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
		  'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
		  'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
		  '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
		  '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
		  '36001051','BF172365') 
		AND SLE.DefectCode IN ('049')
		AND SL.CONTRACTTYPEID in ('3','4','8','38','39','40','48','63','168','172','174','175','176','190','191') 
	THEN 'CD_Parts'
	WHEN im.code IN ('AL121062','AA121150','BA122192','BA103045','AP121132','BF581048','24121145','36DH4061','24151171','24151268',
			     '36AL0051','36AL0050','36AL0052','36BB0052','36AA4144','AL151176','36BB0054','24151071','36BB0053','36AZ0078','AL151179',
			     '36AZ0080','36AZ0076','AL151178','36BF0002','AL151177','36BF0001','83020602','24121400','AF121107','AF141100','AT172140',
			     'BB121050','BA122086','24121652','DD121013','BA122072','BB121043','JG171802','24141109','AF141208','AB121019','36JL0181',
			     '36BA4036','83020473','36AT0003','36RA0012','AN101190','BA102113','AA121006','BA102079','AP121067','JG571014','CD101102',
			     'AL131075','BA133062','BG141252','BG141253','36BA4035','AA111154','AA111153','24116149','AA111058','AZ351207','DG111008',
			     'AZ351206','BF351258','AB111015','JL351218','JG351209','AP121043','AA101154','83020562','36AF0030','JA541019','83020567',
			     '24121729','36AF0066','AF121612','83020651','AA121381','83020565','83020564','36AM0011','83020569','83020566','83020570',
			     '83020571','BF402003','83020504','60111530','83020572','JG571024','3700LABR','3700CHRG','36001051','JA541021','AM121213',
			     '36001051','BF172365') 
	THEN 'PM_Parts'
	ELSE 'Others'
END AS PartRepairType 
,SLE.DefectCode AS DefectCode
,CME.Name AS DefectDescription 
,concat(CME.Name, ' - ' , SLE.DefectCode) as DefectCode_Description -- added on 07/02/2024
,SH.PDIOk AS PDIOk_Flag
,SH.PDINotOk AS PDINotOk_Flag
,SH.PDINowOk AS PDINowOk_Flag
,SL.Qtyinvoiced
,CASE 
	WHEN SH.ISCLOSED = 0 AND (SH.READYFORBILLDATETIME IS NULL OR SH.READYFORBILLDATETIME IS NOT NULL) AND SH.BILLEDDATETIME IS NULL 
	THEN 'Open'
	WHEN SH.ISCLOSED = 1 AND SH.READYFORBILLDATETIME IS NOT NULL AND SH.BILLEDDATETIME IS NOT NULL 
	THEN 'Delivered/Closed'
END AS JobCardStatus
,SL.CONTRACTTYPEID AS FK_PartContractTypeID

FROM SERVICE_HEADER SH
LEFT JOIN SERVICE_LINE SL ON (SL.DOCID = SH.HEADERID AND SL.IMPORTEDDATE = (SELECT MAX(SL1.IMPORTEDDATE) FROM SERVICE_LINE SL1 WHERE SL1.ITEMID = SL.ITEMID AND SL.DOCID = SL1.DOCID))
INNER JOIN SERVICE_CONTRACT_MASTER SCM1 ON SCM1.SERVICECONTRACTID=SH.CONTRACTTYPEID
LEFT JOIN INSTALL_BASE_MASTER IBM ON IBM.IBID=SH.IBID
LEFT JOIN ITEM_GROUP_DETAIL_NEW IG ON IG.ITEMID=SL.ITEMID AND IG.ID = (SELECT MAX(IG1.ID) FROM ITEM_GROUP_DETAIL_NEW IG1 WHERE IG.ITEMID = IG1.ITEMID)
LEFT JOIN ITEM_MASTER IM ON IM.ITEMID=SL.ITEMID
INNER JOIN COMPANY_MASTER CM ON (CM.COMPANYID=SH.COMPANYID AND CM.IMPORTEDDATE = (SELECT MAX(CM1.IMPORTEDDATE) FROM COMPANY_MASTER CM1 WHERE CM.COMPANYID = CM1.COMPANYID)
AND CM.COMPANYTYPE IN (7))
LEFT JOIN SERVICE_LINE_EXT SLE ON SLE.LINEID = SL.LINEID 
LEFT JOIN COMPLAINT_MASTER CME ON CME.Code = SLE.DefectCode 
WHERE CAST(SH.DOCDATE AS DATE) > '2023-11-07'
AND SH.IBID IS NOT NULL
AND SH.CANCELLATIONDATE IS NULL
--AND SL.ISCLOSED<>0
--AND SL.QTYALLOCATED<>0
)BASE

------------------------------UPDATE DELETE FLAG

SELECT DISTINCT SLD.LineID
INTO #DeletedLineID
FROM SERVICE_LINE_DELETED SLD
JOIN ASM_CV_SERVICE_STG ASF ON ASF.LINEID=SLD.LINEID

insert INTO #DeletedLineID
SELECT DISTINCT SLD.LineID
FROM DELETED_SERVICE_LINE SLD
JOIN ASM_CV_SERVICE_STG ASF ON ASF.LINEID=SLD.LINEID


UPDATE ASF
SET ASF.Delete_Flag=1
FROM ASM_CV_SERVICE_STG ASF 
JOIN #DeletedLineID DLI ON DLI.LINEID=ASF.LINEID

drop table #DeletedLineID
-------------------------------UPDATE 3RD FREE TO 1ST PAID DATA

SELECT DISTINCT MAIN_BASE.FK_IBID,FREE_MAIN_BLOCK.FREE_DATE AS [3rd_Fs_Date],PAID_MAIN_BLOCK1.PAID_DATE AS [1st_Ps_Date],FREE_MAIN_BLOCK.USAGEREADING_FS3,PAID_MAIN_BLOCK1.USAGEREADING_PAID1
,ABS(PAID_MAIN_BLOCK1.USAGEREADING_PAID1-FREE_MAIN_BLOCK.USAGEREADING_FS3) AS DIFF
,CASE WHEN DATEDIFF(DAY,FREE_MAIN_BLOCK.FREE_DATE,PAID_MAIN_BLOCK1.PAID_DATE)<90 
          OR ABS(PAID_MAIN_BLOCK1.USAGEREADING_PAID1-FREE_MAIN_BLOCK.USAGEREADING_FS3)<10000 THEN 1 ELSE 0 END AS [3rdFS_To_1stPS]
INTO #3rdFS_To_1stPS_Data
FROM
(SELECT DISTINCT FK_IBID FROM ASM_CV_SERVICE_STG) MAIN_BASE

LEFT JOIN

(SELECT * FROM
(SELECT DISTINCT FK_IBID,SS.DOCDATE AS FREE_DATE
,SS.USAGEREADING AS USAGEREADING_FS3
,ROW_NUMBER() OVER(PARTITION BY FK_IBID ORDER BY SS.DOCDATE) FREE_RNO
FROM ASM_CV_SERVICE_STG SS
WHERE SS.FK_Contracttypeid IN (191,176)) FREE_BLOCK1
WHERE FREE_RNO=1)FREE_MAIN_BLOCK ON FREE_MAIN_BLOCK.FK_IBID=MAIN_BASE.FK_IBID

LEFT JOIN 
(SELECT FK_IBID,PAID_DATE,USAGEREADING_PAID1 FROM
(SELECT FK_IBID,PAID_DATE,USAGEREADING_PAID1
,ROW_NUMBER() OVER(PARTITION BY FK_IBID ORDER BY PAID_DATE ASC) PAID_RNO
FROM
(SELECT BASE.FK_IBID,FREE_BLOCK2.FREE_DATE,PAID_BLOCK.PAID_DATE
,FREE_BLOCK2.USAGEREADING_FS3
,PAID_BLOCK.USAGEREADING_PAID1
,CASE WHEN PAID_BLOCK.PAID_DATE<FREE_BLOCK2.FREE_DATE THEN 1
      WHEN PAID_BLOCK.PAID_DATE>FREE_BLOCK2.FREE_DATE THEN 0 END AS EXCLUDE_FLAG
FROM
(SELECT DISTINCT FK_IBID FROM ASM_CV_SERVICE_STG) BASE
LEFT JOIN

(SELECT * FROM
(SELECT DISTINCT FK_IBID,SS.DOCDATE AS FREE_DATE
,SS.USAGEREADING AS USAGEREADING_FS3
,ROW_NUMBER() OVER(PARTITION BY FK_IBID ORDER BY SS.DOCDATE) FREE_RNO
FROM ASM_CV_SERVICE_STG SS
WHERE SS.FK_Contracttypeid IN (191,176)) FREE_BLOCK1
WHERE FREE_RNO=1)FREE_BLOCK2 ON FREE_BLOCK2.FK_IBID=BASE.FK_IBID
LEFT JOIN
(SELECT DISTINCT FK_IBID,BU
,SS.DOCDATE AS PAID_DATE
,SS.USAGEREADING AS USAGEREADING_PAID1
 FROM ASM_CV_SERVICE_STG SS
WHERE SS.PAIDFLAG=1)PAID_BLOCK ON BASE.FK_IBID=PAID_BLOCK.FK_IBID
) BASE
WHERE EXCLUDE_FLAG<>1)PAID_FINAL_BLOCK
WHERE PAID_RNO=1)PAID_MAIN_BLOCK1 ON PAID_MAIN_BLOCK1.FK_IBID=MAIN_BASE.FK_IBID

UPDATE B
SET B.[3rdFS_To_1stPS]=A.[3rdFS_To_1stPS]
,B.[3rd_Fs_Date]=A.[3rd_Fs_Date]
,B.[1st_Ps_Date]=A.[1st_Ps_Date]
FROM ASM_CV_SERVICE_STG B
JOIN #3rdFS_To_1stPS_Data A ON A.FK_IBID=B.FK_IBID

drop table #3rdFS_To_1stPS_Data

---------------------------------------------------
--EOH Flag Creation for Max PosttaxRevenue Generated Part--
---------------------------------------------------

;WITH RankedData AS (
   SELECT 
	   STG.FK_Docid,
       STG.FK_Ibid,
	   STG.DOCNAME,
	   STG.DOCDATE,
       STG.FK_Itemid,
	   IM.ITEMCODE,
	   Im.ITEMNAME,
       STG.Posttaxrevenue,
       ROW_NUMBER() OVER (PARTITION BY STG.FK_Docid ORDER BY STG.Posttaxrevenue desc) AS RowNum
   FROM 
       ASM_CV_SERVICE_STG STG
INNER JOIN ASM_SERVICE_ITEM_MASTER_DIM IM ON IM.Itemid = STG.FK_Itemid
WHERE STG.FK_PartContractTypeID NOT IN (8,3,63,172,48,176) AND
IM.ITEMCODE IN ('36AA4105', '36AF0044', '36AN0010', '36AN0032', '36AZ0048', '36RA0001', 'AN101133', 'AZ521000', '36AN0016', 
'36AN0033', '36AN0034', '36AZ0046', 'AA101865', 'AF101054', 'AF101058', 'AN101357', 'AZ521200', 'RA521200', 'BA102064', 
'BA102174', '39143520', 'BA122029', 'BA122030', '24101774', '24101925', '24101964', '24101978', 'AS101016', 'AB101067', '36AZ0075',
'36RA0013', 'AN101123', 'AZ521004', 'BF521207', 'BF521214', 'BF521019') AND STG.TYPE = 'Part' AND STG.Delete_Flag = 0
)
 
UPDATE OriginalData
SET EOH_Flag = CASE
   WHEN RankedData.RowNum = 1 THEN 1
   ELSE 0
END
FROM 
   ASM_CV_SERVICE_STG AS OriginalData
JOIN 
   RankedData
ON 
OriginalData.FK_docid = RankedData.FK_docid and
OriginalData.FK_ibid = RankedData.FK_ibid and
OriginalData.FK_itemid = RankedData.FK_itemid;


---------------------------------------------------
--EOH Flag Creation for Max PReTAxRevenue Generated Part--
 ---------------------------------------------------

;WITH RankedData AS (
   SELECT 
	   STG.FK_Docid,
       STG.FK_Ibid,
	   STG.DOCNAME,
	   STG.DOCDATE,
       STG.FK_Itemid,
	   IM.ITEMCODE,
	   Im.ITEMNAME,
       STG.Posttaxrevenue,
       ROW_NUMBER() OVER (PARTITION BY STG.FK_Docid ORDER BY STG.Pretaxrevenue desc) AS RowNum
   FROM 
       ASM_CV_SERVICE_STG STG
INNER JOIN ASM_SERVICE_ITEM_MASTER_DIM IM ON IM.Itemid = STG.FK_Itemid
WHERE STG.FK_PartContractTypeID NOT IN (8,3,63,172,48,176) AND
IM.ITEMCODE IN ('36AA4105', '36AF0044', '36AN0010', '36AN0032', '36AZ0048', '36RA0001', 'AN101133', 'AZ521000', '36AN0016', 
'36AN0033', '36AN0034', '36AZ0046', 'AA101865', 'AF101054', 'AF101058', 'AN101357', 'AZ521200', 'RA521200', 'BA102064', 
'BA102174', '39143520', 'BA122029', 'BA122030', '24101774', '24101925', '24101964', '24101978', 'AS101016', 'AB101067', '36AZ0075',
'36RA0013', 'AN101123', 'AZ521004', 'BF521207', 'BF521214', 'BF521019') AND STG.TYPE = 'Part' AND STG.Delete_Flag = 0
)
 
UPDATE OriginalData
SET EOH_Flag_Pre = CASE
   WHEN RankedData.RowNum = 1 THEN 1
   ELSE 0
END
FROM 
   ASM_CV_SERVICE_STG AS OriginalData
JOIN 
   RankedData
ON 
OriginalData.FK_docid = RankedData.FK_docid and
OriginalData.FK_ibid = RankedData.FK_ibid and
OriginalData.FK_itemid = RankedData.FK_itemid;


---------------------------------------------------------------------------------------------------


---------------------INSERT INTO FACT TABLE

DELETE FROM ASM_CV_SERVICE_FACT WHERE SERVICE_RETAIL_TYPEIDENTIFIER=101

INSERT INTO ASM_CV_SERVICE_FACT(Type,
FK_Contracttypeid,
Lineid,
FK_Docid,
DOCNAME,
Docdate,
FK_Companyid,
FK_Contactid,
Isclosed,
FK_Itemid,
FK_Ibid,
Usagereading,
FK_Branchid,
FK_Modelid,
BU,
COMPANYTYPE,
Isrevisited,
Isrepeated,
[2HrsTat_Delivery],
[7DaysTat_Delivery],
Jcvaluebracket,
Pdt_Flag,
Pdc_Flag,
Pretaxrevenue,
Itemgrouptype,
PaidFlag,
ServiceType,
DealerCode,
Importeddate,
Vehicleinvoicedatetime,
Billeddatetime,
Service_Retail_TypeIdentifier,
Posttaxrevenue,
OpenJC_Buckets_CV,
[3rdFS_To_1stPS],
[1st_Ps_Date],
[3rd_Fs_Date],
TAT_Days,
PDIOk_Flag, 
PDINotOk_Flag, 
PDINowOk_Flag, 
PartRepairType, 
DefectCode, 
DefectDescription, 
DefectCode_Description,
Qtyinvoiced, 
JobCardStatus, 
FK_PartContracttypeid,
EOH_Flag,
EOH_Flag_Pre,
Refresh_Date)

SELECT Type,
FK_Contracttypeid,
Lineid,
FK_Docid,
DOCNAME,
Docdate,
FK_Companyid,
FK_Contactid,
Isclosed,
FK_Itemid,
FK_Ibid,
Usagereading,
FK_Branchid,
FK_Modelid,
BU,
COMPANYTYPE,
Isrevisited,
Isrepeated,
[2HrsTat_Delivery],
[7DaysTat_Delivery],
Jcvaluebracket,
Pdt_Flag,
Pdc_Flag,
Pretaxrevenue,
Itemgrouptype,
PaidFlag,
ServiceType,
DealerCode,
Importeddate,
Vehicleinvoicedatetime,
Billeddatetime,
Service_Retail_TypeIdentifier,
Posttaxrevenue,
CASE WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=1 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<2 THEN '1-2days'
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=2 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<3 THEN '2-3days'
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=3 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<5 THEN '3-5days'    
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=5 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<7 THEN '5-7days'
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=7 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<10 THEN '7-10days'
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=10 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<15 THEN '10-15days'    
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=15 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<20 THEN '15-20days'  
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=20 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))<30 THEN '20-30days'
      WHEN ISCLOSED = 0 AND DATEDIFF(D,CAST(DOCDATE AS DATE),DATEADD(mi,30,(DATEADD(hh,5,getdate()))))>=30 THEN '>30' END AS OpenJC_Buckets_CV,
[3rdFS_To_1stPS],
[1st_Ps_Date],
[3rd_Fs_Date],
TAT_Days,
PDIOk_Flag, 
PDINotOk_Flag, 
PDINowOk_Flag,
PartRepairType,
DefectCode,
DefectDescription,
DefectCode_Description, 
Qtyinvoiced, 
JobCardStatus, 
FK_PartContracttypeid,
EOH_Flag,
EOH_Flag_Pre,
GETDATE() AS Refresh_Date
FROM ASM_CV_SERVICE_STG ASG
WHERE ASG.DELETE_FLAG<>1
AND ASG.CANCELLATIONDATE IS NULL

END
GO