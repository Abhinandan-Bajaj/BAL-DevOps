SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*******************************************HISTORY**************************************************/
/*--------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------*/
/*    DATE   	|	CREATED/MODIFIED BY		|					CHANGE DESCRIPTION					*/
/*--------------------------------------------------------------------------------------------------*/
/*	2024-06-19 	|	Sarvesh Kulkarni		| Added PDT PDC buckets and asd_dealeccode in agr fact table.*/
/*--------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------*/
/*******************************************HISTORY**************************************************/

CREATE PROC [dbo].[USP_ASM_MC_SERVICE_FACT_AGR_FULL] AS
BEGIN
TRUNCATE TABLE ASM_MC_SERVICE_FACT_AGR

INSERT INTO ASM_MC_SERVICE_FACT_AGR
(
[Type],
[FK_Contracttypeid],
[FK_PartContracttypeid],
[FK_Docid],
[DOCNAME],
[Docdate],
[Isclosed],
[FK_Contactid],
[FK_Ibid],
[FK_Branchid],
[FK_Modelid],
[Isrevisited],
[Isrepeated],
[Pdt_Flag],
[Pretaxrevenue],
[Posttaxrevenue],
[Dealercode],
[Chassis_CWI],
[Return_flag],
[1stFS_EXPIRY1_Date],
[2ndFS_EXPIRY1_Date],
[3rdFS_EXPIRY1_Date],
[1stFS_EXPIRY2_Date],
[2ndFS_EXPIRY2_Date],
[3rdFS_EXPIRY2_Date],
[SALESCHANNEL],
[3rdFS_To_1stPS],
[STATUS_1stFS_EXPIRY1],
[STATUS_2NDFS_EXPIRY1],
[STATUS_3RDFS_EXPIRY1],
[STATUS_1stFS_EXPIRY2],
[STATUS_2NDFS_EXPIRY2],
[STATUS_3RDFS_EXPIRY2],
[SELF_REDEEM_1STFS],
[SELF_REDEEM_2NDFS],
[SELF_REDEEM_3RDFS],
[GRACE_PERIOD_1STFS],
[GRACE_PERIOD_2NDFS],
[GRACE_PERIOD_3RDFS],
[Itemgrouptype],
[Bgo_Category],
[Pdc_Flag],
[PaidFlag],
[ServiceType],
[Vehicleinvoicedatetime],
[Billeddatetime],
[PaidDueDate],
[Service_Retail_TypeIdentifier],
[ExpiryDate],
[ReasonForDelay],
[MechanicalSameDayFlag],
[AccidentalFlag],
[Service_Advisor],
[Technician],
[Repeat_Type],
[OpenJc_Buckets_MC],
[Refresh_Date],
[FS_Grace_Flag],
[SS_Grace_Flag],
[TS_Grace_Flag],
ASD_Dealercode
)
SELECT
[Type],
[FK_Contracttypeid],
[FK_PartContracttypeid],
[FK_Docid],
[DOCNAME],
[Docdate],
[Isclosed],
[FK_Contactid],
[FK_Ibid],
[FK_Branchid],
[FK_Modelid],
[Isrevisited],
[Isrepeated],
[Pdt_Flag],
[Pretaxrevenue],
[Posttaxrevenue],
[Dealercode],
[Chassis_CWI],
[Return_flag],
[1stFS_EXPIRY1_Date],
[2ndFS_EXPIRY1_Date],
[3rdFS_EXPIRY1_Date],
[1stFS_EXPIRY2_Date],
[2ndFS_EXPIRY2_Date],
[3rdFS_EXPIRY2_Date],
[SALESCHANNEL],
[3rdFS_To_1stPS],
[STATUS_1stFS_EXPIRY1],
[STATUS_2NDFS_EXPIRY1],
[STATUS_3RDFS_EXPIRY1],
[STATUS_1stFS_EXPIRY2],
[STATUS_2NDFS_EXPIRY2],
[STATUS_3RDFS_EXPIRY2],
[SELF_REDEEM_1STFS],
[SELF_REDEEM_2NDFS],
[SELF_REDEEM_3RDFS],
[GRACE_PERIOD_1STFS],
[GRACE_PERIOD_2NDFS],
[GRACE_PERIOD_3RDFS],
[Itemgrouptype],
[Bgo_Category],
[Pdc_Flag],
[PaidFlag],
[ServiceType],
[Vehicleinvoicedatetime],
[Billeddatetime],
[PaidDueDate],
[Service_Retail_TypeIdentifier],
[ExpiryDate],
[ReasonForDelay],
[MechanicalSameDayFlag],
[AccidentalFlag],
[Service_Advisor],
[Technician],
[Repeat_Type],
[OpenJc_Buckets_MC],
GETDATE() as Refresh_Date,
[FS_Grace_Flag],
[SS_Grace_Flag],
[TS_Grace_Flag],
ASD_Dealercode
FROM 
ASM_MC_SERVICE_FACT
where [Service_Retail_TypeIdentifier] in (102,103,104);
--------------------------------------------------------

INSERT INTO ASM_MC_SERVICE_FACT_AGR(Type,
FK_Contracttypeid,
FK_PartContracttypeid,
FK_Docid,
DOCNAME,
Docdate,
FK_Contactid,
Isclosed,
FK_Ibid,
FK_Branchid,
FK_Modelid,
Isrevisited,
Isrepeated,
ReasonForDelay,
Repeat_Type,
MechanicalSameDayFlag,
AccidentalFlag,
Pdt_Flag,
Pdc_Flag,
Pretaxrevenue,
Itemgrouptype,
Bgo_Category,
PaidFlag,
ServiceType,
[Dealercode],
Vehicleinvoicedatetime,
Billeddatetime,
Service_Retail_TypeIdentifier,
Posttaxrevenue,
OpenJC_Buckets_MC,
[3rdFS_To_1stPS],
Technician,
Service_Advisor,
Refresh_Date,
ASD_Dealercode,
PDC_deviation_buckets,
PDT_deviation_buckets
)

SELECT 
Type,
FK_Contracttypeid,
FK_PartContracttypeid,
FK_Docid,
DOCNAME,
Docdate,
FK_Contactid,
Isclosed,
FK_Ibid,
FK_Branchid,
FK_Modelid,
Isrevisited,
MAX(Isrepeated) AS Isrepeated,
ReasonForDelay,
Repeat_Type,
MechanicalSameDayFlag,
AccidentalFlag,
Pdt_Flag,
Pdc_Flag,
SUM(Pretaxrevenue) AS Pretaxrevenue,
Itemgrouptype,
Bgo_Category,
PaidFlag,
ServiceType,
Dealercode,
Vehicleinvoicedatetime,
Billeddatetime,
Service_Retail_TypeIdentifier,
SUM(Posttaxrevenue) AS Posttaxrevenue,
OpenJC_Buckets_MC,
[3rdFS_To_1stPS],
Technician,
Service_Advisor,
GETDATE() AS Refresh_Date,
ASD_Dealercode,
PDC_deviation_buckets,
PDT_deviation_buckets
FROM ASM_MC_SERVICE_FACT ARS
where Service_Retail_TypeIdentifier=101
GROUP BY
Type,
FK_Contracttypeid,
FK_PartContracttypeid,
FK_Docid,
DOCNAME,
Docdate,
FK_Contactid,
Isclosed,
FK_Ibid,
FK_Branchid,
FK_Modelid,
Isrevisited,
ReasonForDelay,
Repeat_Type,
MechanicalSameDayFlag,
AccidentalFlag,
Pdt_Flag,
Pdc_Flag,
Itemgrouptype,
Bgo_Category,
PaidFlag,
ServiceType,
Dealercode,
Vehicleinvoicedatetime,
Billeddatetime,
Service_Retail_TypeIdentifier,
[3rdFS_To_1stPS],
Technician,
Service_Advisor,
ASD_Dealercode,
PDC_deviation_buckets,
PDT_deviation_buckets,
OpenJC_Buckets_MC;

END
GO